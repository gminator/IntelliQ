<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Chat Client</title>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Font Awesome CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

   
    <style>
        .popover {
            max-width: none; /* Allow the popover to expand beyond its default max-width */
            width: 800px; /* Set your desired width */
        }
    </style>
</head>
<body>
            

    {% include "menu.html" %}

    <div class="container mt-4">
        <h2 class="mb-4">Chat Client</h2>
        <div id="chat-box" class="mb-4"></div>
        <div class="input-group">
            <input type="text" id="message-input" class="form-control" placeholder="Type your message...">
            <button id="send-button" class="btn btn-primary " onclick="sendMessage()">Send</button>
            <div id="loading-indicator" class="text-primary d-none" role="status" style="padding-left: 10px;padding-top: 5px;">
                <i class="fa-solid fa-spinner fa-spin fa-2xl"></i>
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <script>
    function appendMessage(message, sender, showCopyButton) {
        const catalog =  {{ catalog|tojson|safe }};
        const chatBox = document.getElementById('chat-box');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message mb-2 ${sender === 'You' ? 'user-message' : 'intelliq-message'}`;
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
        if (showCopyButton) {
            const copyButton = document.createElement('button');
            copyButton.className = 'btn btn-outline-secondary btn-sm ms-2';
            copyButton.innerHTML = '<i class="fas fa-copy"></i>';
            copyButton.addEventListener('click', function() {
                copyToClipboard(message);
            });
            messageDiv.appendChild(copyButton);
        }
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        // var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        //             var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        //                 return new bootstrap.Popover(popoverTriggerEl)
        //             })

        $(".references").each(function(){
            if(catalog[$(this).attr("document-id")]['abstract'])
            {
                $(this).find("strong").popover({
                    trigger : "hover",
                    placement : "bottom",
                    title : "Abstract", 
                    content : catalog[$(this).attr("document-id")]['abstract']
                })
            }
        })
    }

    function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        if (message !== '') {
            appendMessage(message, 'You', false);
            // Show loading indicator
            document.getElementById('loading-indicator').classList.remove('d-none');
            // Send the message to the server via AJAX
            $.ajax({
                type: 'POST',
                url: '/respond',
                data: { message: message },
                success: function(response) {
                    // Hide loading indicator
                    document.getElementById('loading-indicator').classList.add('d-none');
                    // Format new lines to <br> tags in the response
                    const formattedResponse = response.message.replace(/\n/g, '<br>');
                    // Append the formatted response from the server to the chat window
                    appendMessage(formattedResponse, 'IntelliQ', true);
                },
                error: function(xhr, status, error) {
                    // Hide loading indicator
                    document.getElementById('loading-indicator').classList.add('d-none');
                    console.error('Error:', error);
                    // Show error message in the chat window
                    appendMessage('An error occurred. Please try again.', 'System', false);
                }
            });
            messageInput.value = '';
        }
    }

    function copyToClipboard(text) {
        const tempInput = document.createElement('input');
        tempInput.value = text;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        alert('Copied to clipboard');
    }

    // Function to handle incoming messages (you need to implement this)
    function receiveMessage(message) {
        appendMessage(message, 'IntelliQ', true);


    }

    // Example of receiving a message (you need to implement this)
    receiveMessage('Hello! How can I help you?');

    // Add event listener for key press event
    document.getElementById('message-input').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });
</script>


</body>
</html>
